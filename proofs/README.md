# Tamarin models

This folder contains instructions to run our formal verification artifacts with
Tamarin Prover, to reproduce the results of Section VI and Appendix A of our
paper.

## Overview

We developed two Tamarin models: one for the main design, where the Revocation
Authority (RA) distributes timing information to the vehicles, who ise such
information to synchronize their time (Section V), and another that assumes that
all vehicles have a trusted time source that can progress autonomously (Section
V-B). These models are divided in two sub-folders:
- `centralized-time` contains the first model, and
- `distributed-time` contains the second model.

Both models are defined in the files called `theory.spthy`. 

We successfully verified all the lemmas in the models using Tamarin version
`1.6.1` and `1.8.0`. Outputs from previous executions are found in `output.txt`
and `output.spthy`.

The oracles `oracle.py` help Tamarin to create efficient proofs and allow it to
terminate. Without it, Tamarin would either use too much memory or get stuck in
some proofs. See the [Tamarin
guide](https://tamarin-prover.github.io/manual/master/book/011_advanced-features.html)
for more information.

More details can be found in the paper (Sect. VI and Appendix A).

## Prerequisites

We offer the possibility to run our models both locally and using Docker. In
both cases, the artifact requires a Linux-based operating system to run. We
tested our artifacts on Ubuntu 22.04 and Debian 12, but other (recent)
distributions should work as well.

Make sure your machine has at least **4 GB of RAM available**, otherwise Tamarin
might not be able to complete (i.e., it might be killed due to OOM exceptions).

## Run with Docker

We built Docker images from the Tamarin [official
repository](https://github.com/tamarin-prover/tamarin-prover). We used the
official Dockerfile found under `etc/docker`. We only slightly modified the
Dockerfile to install Python 3, in order to run our oracles.

The Docker images are publicly available at `selfrevocation/tamarin`. Different
tags use different Tamarin versions:
- `latest` (or `v1.8.0`) was built from tag `1.8.0`, which corresponds to the
  official Tamarin release `1.8.0`.
- `v1.6.1` was built from tag `1.6.1`, which corresponds to the official
  Tamarin release `1.6.1`.

We provide a Makefile with targets to prove the two models using Docker. Make
sure `make` is installed, e.g., on Ubuntu/Debian: `sudo apt install make`.

### Run

The target `prove` is used to run Tamarin in the background. The model to prove
can be chosen by overriding the `MODEL` variable, indicating either
`centralized-time` (default) or `distributed-time`. The default Tamarin version
used by the targets is `v1.6.1`. Each of the models should verify within 5
minutes.

```bash
# run container to verify the main design (discussed in Sections V, VI and Appendix A)
make prove MODEL=centralized-time

# *grab a coffee* -- make sure you do not close the current shell!

# After a few minutes, Tamarin completes and exits. Check output to verify
# if all lemmas have been verified correctly

# Delete container
docker rm tamarin
```

After the container terminates, the complete proof generated by Tamarin can be
found under `out/output.spthy`.

To verify the alternative design discussed in Section V-B and Appendix A, simply
replace `MODEL=centralized-time` with `MODEL=distributed-time` in the `make
prove` above. Make sure that the previous container has completed before running
the new one.

### (Optional) Run in the background

When Tamarin takes a long time to verify, you can run the container in the
background (in "detached" mode) such that is not attached to the current shell.
This is useful when, e.g., you are connected to a remote server with SSH and you
can't (or don't want to) keep the shell open the whole time.

```bash
# run container to verify the main design in the background
make prove MODEL=centralized-time BACKGROUND=1

# *grab a coffee* -- you can safely close the current shell here

# Check if container is still running
watch docker ps -a --filter name=tamarin

# When the container exits it means that Tamarin has completed. Let's check results
docker logs -n 50 tamarin

# Delete container
docker rm tamarin
```

### (Optional) Interactive mode

Tamarin can run in interactive mode thanks to an intuitive web application. The
target `interactive` is used for this purpose.

**NOTE**: this is _not_ necessary for reproducing our results. The steps above
are alredy sufficient to prove both models.

Example:

```bash
# Run container in the background.
make interactive MODEL=centralized-time

# The Tamarin interactive webapp will be available at localhost:3001

# Stop container and clean up
make clean
```

## Run locally

Python 3 is required to run the oracles: `sudo apt install python3`.
[Homebrew](https://brew.sh/) is also required to install Tamarin.

Below we give instructions to install the latest Tamarin version (currently
1.8.0), or version 1.6.1. Choose the version you prefer. More installation
instructions are provided
[here](https://tamarin-prover.com/manual/master/book/002_installation.html).

### Tamarin installation (LATEST VERSION)

```bash
# Install Tamarin
brew install tamarin-prover/tap/tamarin-prover

# Check version
tamarin-prover --version
```


### Tamarin installation (VERSION 1.6.1)

```bash
# Get brew formula of Tamarin 1.6.1
wget https://raw.githubusercontent.com/tamarin-prover/homebrew-tap/e6696f0f3c1f131b633c98aa657c5792c6d07737/Formula/tamarin-prover.rb -O tamarin-prover.rb

# Install Tamarin
brew install tamarin-prover.rb

# Check that we have indeed installed tamarin 1.6.1
tamarin-prover --version

# Remove brew formula
rm tamarin-prover.rb
```

### Run

For best results, we recommend using 4 threads. Each of the models should
complete within 5-10 minutes.

```bash
# Verify the main design (discussed in Sections V, VI and Appendix A)
tamarin-prover --prove --output=output_centralized.spthy centralized-time/theory.spthy +RTS -N4 -RTS

# Verify the alternative design (discussed in Section V-B and Appendix A)
tamarin-prover --prove --output=output_distributed.spthy distributed-time/theory.spthy +RTS -N4 -RTS
```

The complete proofs generated by Tamarin can be found in
`output_{centralized,distributed}.spthy`.